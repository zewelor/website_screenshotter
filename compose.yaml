services:
  screenshots:
    image: mcr.microsoft.com/playwright:v1.57.0-noble
    working_dir: /work
    ipc: host
    network_mode: host  # Fixes rootless podman cleanup error + allows screenshotting localhost
    cap_drop:
      - ALL
    cap_add:
      - SYS_ADMIN  # Required for Chromium sandboxing
    security_opt:
      - no-new-privileges:true
    mem_limit: 2g
    pids_limit: 500
    volumes:
      - ./screenshot.mjs:/work/screenshot.mjs:ro
      - ./output:/output:z
    tmpfs:
      - /work/node_modules
    environment:
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1
      - URL=${URL:-https://example.com}
      - OUTPUT_DIR=/output
      - DESKTOP_WIDTH=${DESKTOP_WIDTH:-1920}
      - DESKTOP_HEIGHT=${DESKTOP_HEIGHT:-1080}
      - MOBILE_WIDTH=${MOBILE_WIDTH:-390}
      - MOBILE_HEIGHT=${MOBILE_HEIGHT:-844}
      - SCROLL_STEP=${SCROLL_STEP:-800}
      - SCROLL_DELAY=${SCROLL_DELAY:-500}
      - TIMEOUT=${TIMEOUT:-30000}
    command: sh -c "npm install --silent playwright@1.57.0 && node screenshot.mjs"
